---
layout: blog
---

<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Private is not for safety</title>

    </head>
    <body>
        <h1>Encapsulation is not for security</h1>
        <h5 style="color: #777;">March 30, 2024</h5>

        <p style="font-size: medium;font-style: italic;">Before we begin, for
            those who don't know, encapsulation is part of Object Oriented
            Programming (OOP) languages that allows for a clear demarcation
            between what data/methods a class has access to and what "everyone"
            has access to. The most common way this is done in different
            programming languages is with the <span
                class="inline-code">private</span> keyword to certain
            variables/methods (this is not the only
            way, which is discussed later on), which restricts access to "only"
            the class.</p>
        <p>There seems to be a lot of confusion about what <span
                class="inline-code">Private</span> (and encapsulation in
            general) <i>actually</i> means in your code.
            The following Reddit posts (which inspired me to make this blog
            post) are a great example of what I mean.</p>
        <div style="display: flex;">
            <blockquote class="reddit-embed-bq" style="height:500px; flex:1"
                data-embed-theme="dark" data-embed-height="740"><a
                    href="https://www.reddit.com/r/ProgrammerHumor/comments/1bjx1eo/itseemssafer/">itSeemsSafer</a><br>
                by<a
                    href="https://www.reddit.com/user/SSpectre86/">u/SSpectre86</a>
                in<a
                    href="https://www.reddit.com/r/ProgrammerHumor/">ProgrammerHumor</a></blockquote><script
                async src="https://embed.reddit.com/widgets.js"
                charset="UTF-8"></script>
            &nbsp;
            <blockquote class="reddit-embed-bq" style="height:500px; flex:1"
                data-embed-theme="dark" data-embed-height="642"><a
                    href="https://www.reddit.com/r/ProgrammerHumor/comments/16tq4kl/thiswillneverpassanycodereviewbutitworks/">thisWillNeverPassAnyCodeReviewButItWorks</a><br>
                by<a
                    href="https://www.reddit.com/user/marcobsidian02/">u/marcobsidian02</a>
                in<a
                    href="https://www.reddit.com/r/ProgrammerHumor/">ProgrammerHumor</a></blockquote><script
                async src="https://embed.reddit.com/widgets.js"
                charset="UTF-8"></script>
        </div>
        <p>These posts seem to suggest that private class
            members/variables/methods (I will just be using "variables" for the
            rest of the post for the sake of brevity) are marked as such for
            safety/security purposes (I will be using safety and security
            interchangeably). <b>They are not.</b> </p>

        <p>The point of <span class="inline-code">private</span> is to signal to
            other programmers that a certain variable should only be managed by
            the class. It's a contract that the team, package author, and/or
            your past self agrees to as civilized programmers, Ã  la <a
                href="https://en.wikipedia.org/wiki/Social_contract"
                target="_blank">the social
                contract</a>.</p>

        <p>Take the following C++ code for example:</p>

        <pre>
    <code class="language-cpp">
class MyClass{
    private:
        int val;
        bool isEven;
    public:
        MyClass(int startVal): val(startVal), isEven(val%2==0){};
        void setVal(int newVal){
            this->val = newVal;
            this->isEven = this->val%2==0;
        }
        void handle(){
            if(isEven){
                std::cout << val << " is even" << std::endl;
            }else{
                std::cout << val << " is odd" << std::endl;
            }
        }
};
    </code>
</pre>

        <p>This class takes an <span class="inline-code">int</span> and stores
            it along with if it is even as <span
                class="inline-code">private</span> variables. This class also
            has a setter for the value and a method to print out the value and
            if it is even or odd.</p>

        <pre>
        <code class="language-cpp">
MyClass myObject(5);

myObject.handle();
myObject.setVal(4);
myObject.handle();
        </code>
    </pre>

        <p>Running the above code, we get the output we expect.</p>
        <pre class="command-line"><code>
5 is odd
4 is even
    </code></pre>
        <p>And if we try to access a private variable, like</p>
        <pre class="language-cpp"><code>myObject.val = 5;</code></pre>

        <p>We get a compiler warning, <span class="inline-code">error: 'val' is
                a private member of 'MyClass'</span></p>

        <p>This is all fine and good and what we expected. The class is able to
            manage its own state
            so nothing unexpected can happen. There seems to be no way for this
            object to end up in the wrong state, like stating <span
                class="inline-code">7 is even</span>, but, using a bit of
            pointer magic, we can modify any private variables, putting the
            class into an incorrect state.</p>
        <pre><code class="language-cpp">
*((int *)&myObject) = 7;
myObject.handle();
    </code></pre>
        <pre class="command-line"><code>
7 is even
    </code></pre>
        <p><a href="https://i.imgflip.com/7mfzw6.jpg" ,
                target="_blank">Woah</a>. Our object is now in the completely
            wrong state. Our object might now do unintended actions because it
            makes assumptions about its state that are wrong.</p>
        <p>This is obviously
            a contrived example as we could have just called the <span
                class="inline-code">setVal</span> method. I also think it goes
            without saying, but <b>do not use this in real code</b>, you'll be
            breaking
            the contract and making it harder to reason about your code. For
            that reason, I will not be going into how to do this for some random
            object (but it should be fairly easy to deduce how to do it).</p>
        <p>This even works with <span class="inline-code">-O3</span> and <span
                class="inline-code">-Wall -Wextra -Wpedantic</span> does not
            warn you, but this is most definitely undefined behavior, so it's
            not guaranteed to work every time (the compiler might pre-compute
            everything in an attempt to be fast; see <a
                href="https://youtu.be/w3_e9vZj7D8" target="_blank">this</a>
            video by Eskil Steenberg Hald for some more information on how UB
            makes
            C and (potentially) C++ fast), although the order of the variables
            in memory is
            defined to be
            the order in which they are declared. C++ also has <span
                class="inline-code">friend</span> methods, which allows access
            to private variables from outside of the class, but I did not use
            them (or something like <span class="inline-code">#define private
                public</span>) in order to make this post a bit more
            generic.</p>
        <p>It is possible that <i>your favorite OOP language</i> doesn't have
            the ability to modify private variables, regardless of how much
            wizardry you use, but that just means that the language itself is
            just enforcing the contract, closing any loopholes. There is no
            added security to those variables. As far as I am aware, no
            (compiled) language checks if the code accessing a private variable
            is part of the class during runtime, so, to a malicious user, it
            doesn't matter that the variable is private.</p>
        <p>It is also possible that <i>your favorite OOP language</i> has no
            private or similar keyword (*cough* python *cough*). I would argue,
            however, that the contract does not require any language
            enforcement,
            but only the understanding between the programmers for what means
            <span class="inline-code">private</span>. Take the following Python
            implementation of <span
                class="inline-code">MyClass</span> for example:</p>
        <pre><code class="language-python">
class MyClass:
    _val: int
    _isEven: bool

    def __init__(self, val: int):
        self._val = val
        self._isEven = self._val%2==0
    
    def setVal(self, newVal: int)->None:
        self._val = newVal
        self._isEven = self._val%2==0
    
    def handle(self)->None:
        if self._isEven:
            print(f"{self._val} is even")
        else:
            print(f"{self._val} is odd")
    </code></pre>

        <p>In Python, the community has agreed that a "_" or "__" in front of a
            variable means that it is private (a "__" in front of a variable
            name actually does some name mangling, making it easier to inherit
            from it without clashing with the name of the private variable, but
            it is still accessible externally). As long as the other people
            using this class also agree and uphold the contract, then they are
            just as private as the C++ implementation. And just like in C++, you
            are even able to modify the private variables outside of the class,
            albeit without any pointer magic needed.</p>
        <pre><code class="language-python">
myObject = MyClass(5)
myObject._val = 4
myObject.handle()
    </code></pre>
        <pre class="command-line"><code>
4 is odd
    </code></pre>
    <p>
        It's not hard to imagine that ignoring <span
            class="inline-code">private</span> in the ways shown above could
        lead to a security risk, like changing the size of a buffer to an
        incorrect size or leaking a key. However, on the way to the security
        risk, you had to break the contract.
    </p>
        <p>I should also quickly mention getters and setters. Their use does not
            necessarily mean you are breaking the contract, but, as the author
            of the class, you shouldn't add them all willy-nilly. Having a
            "naked" setter, a setter that only updates the
            underlying value, would just be a more official way to break the
            contract. If you don't need the object to manage that variable, then
            it should be public in the first place. If you need to have a setter
            for a variable, then (1) make
            sure it is a valid value for your class and (2) update the state to
            match the new value. For getters,
            if your language/return type is not "return by copy", then you are
            allowing potential, unintended state changes if they modify the returned
            variable. You also should only have them if other parts of the code
            <b>need</b> to know that value.</p>

        <p>
            There is one other part of encapsulation, <span
                class="inline-code">protected</span>, which allows child
            classes to modify these variables while still being "inaccessible"
            to outside code. This is just an extra part of the contract. The
            parent class trusts that their children will keep up with that
            state correctly.
        </p>
       

        <p>The contract is what is important with encapsulation, whether it is
            through language enforcement or community, because your objects need
            to be able to trust that they can manage the state they <i>need</i>
            to manage. While it is certainly possible that breaking
            encapsulation via whatever means could lead to a security risk, that
            is a symptom of the state not being managed by the object. So
            please, stop making Reddit Post saying <span
                class="inline-code">private</span> is for security reasons or
            that OOP languages like Python do not have <span
                class="inline-code">private</span>. And please, do not break the
            contract.</p>
        <hr>
        <!-- <i style="font-size: small;">I am currently looking for a software
            engineer job opportunity, please message me on <a
                href="{{site.linkedIn}}">LinkedIn</a> if your company is hiring.
            Thanks</i> -->
    </body>
</html>